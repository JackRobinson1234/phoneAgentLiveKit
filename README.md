# Health Agent - LLM-Enhanced AI Doctor Appointment Scheduler

An intelligent AI agent that uses state machines and Large Language Models (LLMs) to handle doctor appointment scheduling conversations with natural language understanding.

## 🚀 Features

### Core Functionality
- **LLM-Enhanced Conversations**: Uses OpenRouter API with Claude 3.5 Sonnet and GPT-4 for natural language understanding
- **State Machine Architecture**: 9-state conversation flow with intelligent transitions
- **Tool-Based Processing**: LLM function calling for intent detection, entity extraction, and response generation
- **Mock Database**: Complete appointment management system with doctors, patients, and scheduling
- **Fallback Support**: Graceful degradation to basic NLP when LLM is unavailable

### LLM Integration
- **OpenRouter Support**: Access to multiple LLM providers (Anthropic, OpenAI, etc.)
- **Function Calling**: Structured tool use for appointment scheduling tasks
- **Context Awareness**: Maintains conversation context across turns
- **Intelligent Responses**: Natural, contextual responses generated by LLMs

## 📋 Prerequisites

1. **Python 3.11+** (Python 3.13 supported)
2. **OpenRouter API Key** - Get one at [openrouter.ai](https://openrouter.ai)

## 🛠️ Installation

### 1. Clone and Setup
```bash
git clone <repository-url>
cd HealthAgent
pip install -r requirements.txt
```

### 2. Configure API Key
```bash
# Copy the example environment file
cp .env.example .env

# Edit .env and add your OpenRouter API key
echo "OPENROUTER_API_KEY=your_api_key_here" > .env
```

### 3. Test Installation
```bash
python main.py
# In the CLI, type: llm-test
```

## 🎯 Usage

### Basic Usage
```bash
python main.py
```

### CLI Commands
- `help` - Show available commands
- `llm-test` - Test LLM integration
- `status` - Show conversation status
- `doctors` - List available doctors
- `specialties` - List medical specialties
- `stats` - Show system statistics
- `reset` - Start new conversation
- `quit` - Exit application

### Natural Language Examples
```
"I need to schedule an appointment with a cardiologist"
"Book me with Dr. Johnson tomorrow at 2pm"
"My name is John Smith, email john@example.com"
"I prefer morning appointments next week"
```

## 🏗️ Architecture

### LLM-Enhanced State Flow
```
GREETING → COLLECT_PATIENT_INFO → COLLECT_APPOINTMENT_TYPE → 
COLLECT_DOCTOR_PREFERENCE → COLLECT_DATE_TIME → SHOW_AVAILABILITY → 
CONFIRM_APPOINTMENT → BOOKING_COMPLETE
```

### Project Structure
```
HealthAgent/
├── agents/
│   ├── llm_health_agent.py      # Main LLM-enhanced agent
│   ├── llm_service.py           # OpenRouter API integration
│   ├── llm_nlp_processor.py     # LLM-based NLP processing
│   └── conversation_handler.py  # Context management
├── state_machine/
│   ├── llm_state.py            # LLM-enhanced base state
│   ├── llm_states.py           # LLM-powered state implementations
│   └── state_machine.py        # State machine engine
├── models/
│   ├── database.py             # Mock database
│   ├── doctor.py               # Doctor model
│   ├── patient.py              # Patient model
│   └── appointment.py          # Appointment model
├── config/
│   └── settings.py             # LLM and system configuration
└── tests/
    └── test_llm_integration.py  # LLM integration tests
```

## 🤖 LLM Configuration

### Supported Models
- **Primary**: `anthropic/claude-3.5-sonnet`
- **Intent Detection**: `openai/gpt-4o-mini`
- **Fallback**: `openai/gpt-3.5-turbo`

### Tool Functions
The system uses structured function calling for:
- **Intent Analysis**: Understanding user requests
- **Entity Extraction**: Names, contact info, preferences
- **DateTime Parsing**: Natural language date/time processing
- **Response Generation**: Contextual, helpful responses

### Configuration Options
Edit `config/settings.py` to customize:
- Model selection
- Temperature and token limits
- Tool usage preferences
- Fallback behavior

## 🧪 Testing

### Run All Tests
```bash
python tests/test_health_agent.py
python tests/test_llm_integration.py
```

### Test LLM Integration
```bash
python main.py
> llm-test
```

### Example Conversation Test
```bash
python tests/test_llm_integration.py
```

## 🔧 Troubleshooting

### LLM Connection Issues
1. **Check API Key**: Ensure `OPENROUTER_API_KEY` is set correctly
2. **Test Connection**: Use `llm-test` command
3. **Check Credits**: Verify OpenRouter account has credits
4. **Fallback Mode**: System automatically falls back to basic NLP if LLM fails

### Common Issues
- **Python 3.13 Compatibility**: All dependencies are compatible
- **Missing Dependencies**: Run `pip install -r requirements.txt`
- **API Rate Limits**: System includes retry logic and fallback

### Debug Mode
```bash
# Enable verbose logging
export OPENROUTER_DEBUG=1
python main.py
```

## 📊 System Statistics

The system tracks:
- LLM usage and performance
- Conversation success rates
- Tool calling statistics
- Fallback usage patterns

Access via `stats` command in CLI.

## 🔒 Security & Privacy

- API keys stored in environment variables
- No conversation data sent to external services beyond OpenRouter
- Mock database - no real patient data
- Input sanitization and validation

## 🚀 Advanced Usage

### Custom Models
Edit `config/settings.py` to use different models:
```python
AVAILABLE_MODELS = {
    'conversation': 'anthropic/claude-3.5-sonnet',
    'intent_detection': 'openai/gpt-4o-mini',
    # Add your preferred models
}
```

### API Integration
The system can be extended to integrate with real healthcare APIs:
- EHR systems
- Appointment scheduling platforms
- Payment processing
- SMS/Email notifications

## 📈 Performance

- **Response Time**: ~1-3 seconds with LLM
- **Accuracy**: 90%+ intent detection with LLM
- **Fallback**: <100ms with basic NLP
- **Reliability**: Automatic error recovery and retry logic

## 🤝 Contributing

1. Fork the repository
2. Create feature branch
3. Add tests for new functionality
4. Ensure LLM integration tests pass
5. Submit pull request

## 📄 License

MIT License - see LICENSE file for details.
